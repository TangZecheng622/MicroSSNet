#' Calculate Network Vulnerability
#'
#' This function calculates the vulnerability of each node and returns the maximum vulnerability of the network.
#'
#' @param cor Numeric matrix representing the undirected correlation network.
#' @return A numeric value representing the maximum node vulnerability in the network.
#' @importFrom igraph graph_from_adjacency_matrix degree delete_vertices vcount distances is_igraph
#' @export
Vulnerability <- function(cor) {
  # Parameter checks
  if (!is.matrix(cor) && !is.data.frame(cor)) stop("Error: 'cor' must be a matrix or data frame.")
  if (nrow(cor) != ncol(cor)) stop("Error: 'cor' must be a square matrix.")

  cor1 <- as.matrix(cor)
  diag(cor1) <- 0
  cor1[abs(cor1) > 0] <- 1
  g <- igraph::graph_from_adjacency_matrix(cor1, mode = "undirected", weighted = NULL, diag = FALSE)

  # Remove isolated nodes
  iso_node_id <- which(igraph::degree(g) == 0)
  if (length(iso_node_id) > 0) {
    g <- igraph::delete_vertices(g, iso_node_id)
  }

  # Calculate network efficiency
  network_efficiency <- function(graph) {
    if (!igraph::is_igraph(graph)) stop("Error: Please provide a valid igraph object.")
    dist_inv <- 1 / igraph::distances(graph)
    diag(dist_inv) <- NA
    mean(dist_inv, na.rm = TRUE)
  }

  net_eff <- network_efficiency(g)

  # Calculate vulnerability for each node
  info_centrality_vertex <- function(graph, net_eff) {
    if (!igraph::is_igraph(graph)) stop("Error: Please provide a valid igraph object.")
    n <- igraph::vcount(graph)
    vulnerabilities <- numeric(n)
    for (i in seq_len(n)) {
      g_removed <- igraph::delete_vertices(graph, i)
      eff_removed <- network_efficiency(g_removed)
      vulnerabilities[i] <- (net_eff - eff_removed) / net_eff
    }
    return(vulnerabilities)
  }

  node_vul <- info_centrality_vertex(g, net_eff)

  # Return the maximum node vulnerability
  max_vul <- max(node_vul, na.rm = TRUE)
  return(max_vul)
}
